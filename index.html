<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Secure Payment</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Valley Crane Theme Colors --- */
        :root { --vc-blue: #004E7C; --vc-teal-bg: #B2E4E2; --vc-teal-border: #8CB6B5; --vc-input-bg: rgba(255, 255, 255, 0.6); --vc-text: #0a3d62; }
        body { font-family: 'Open Sans', sans-serif; padding: 20px; color: var(--vc-text); background-color: #ffffff; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .payment-container { background-color: var(--vc-teal-bg); padding: 40px; border-radius: 12px; width: 100%; max-width: 700px; box-sizing: border-box; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h3 { font-family: 'Montserrat', sans-serif; color: var(--vc-text); font-weight: 700; margin-top: 0; margin-bottom: 30px; font-size: 1.25rem; text-align: center; }
        .method-card { border: 1px solid var(--vc-teal-border); padding: 15px 25px; margin-bottom: 15px; border-radius: 8px; cursor: pointer; background-color: rgba(255,255,255,0.15); transition: all 0.2s ease; }
        .method-card:hover { background-color: rgba(255,255,255, 0.4); }
        .method-card.active { background-color: #ffffff; border-color: var(--vc-blue); box-shadow: 0 2px 8px rgba(0,78,124,0.1); }
        .fields-container { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: none; }
        .method-card.active .fields-container { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        input, select { width: 100%; padding: 14px; margin-bottom: 15px; box-sizing: border-box; background-color: var(--vc-input-bg); border: 1px solid var(--vc-teal-border); border-radius: 5px; font-size: 15px; color: #333; transition: border-color 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--vc-blue); background-color: #ffffff; box-shadow: 0 0 0 3px rgba(0, 78, 124, 0.1); }
        label { font-size: 16px; font-weight: 600; color: var(--vc-text); display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0; }
        input[type="radio"] { width: 20px; height: 20px; margin: 0; accent-color: var(--vc-blue); }
        button { width: 100%; padding: 18px; background: var(--vc-blue); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 800; cursor: pointer; font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 1px; margin-top: 25px; transition: background 0.3s, transform 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:hover { background: #00365a; }
        button:active { transform: translateY(1px); }
        #loading-ui { text-align: center; padding: 40px; display: none; }
        ::placeholder { color: #6d8a96; opacity: 1; }
        .cc-row { display: flex; gap: 15px; }
        .cc-row input { text-align: center; } 
        
        /* Error Box Styling */
        #status-log { 
            margin-top: 20px; 
            padding: 15px; 
            font-size: 14px; 
            color: #d8000c; 
            background-color: #ffd2d2; 
            border: 1px solid #d8000c; 
            width: 100%; 
            max-width: 700px; 
            border-radius: 6px; 
            display: none; 
            text-align: center;
            font-weight: 600;
        }
    </style>
</head>
<body>

    <div class="payment-container">
        <div id="payment-interface">
            <h3>Register Payment Information</h3>
            
            <div class="method-card active" id="btn-select-card">
                <label><input type="radio" name="paymentSelector" value="card" checked> Credit Card</label>
                <div class="fields-container" id="card-fields">
                    <input type="text" id="cardNumber" placeholder="Card Number" maxlength="19">
                    <div class="cc-row">
                        <input type="text" id="expMonth" placeholder="MM" maxlength="2">
                        <input type="text" id="expYear" placeholder="YY" maxlength="2">
                        <input type="text" id="cardCode" placeholder="CVV" maxlength="4">
                    </div>
                </div>
            </div>

            <div class="method-card" id="btn-select-bank">
                <label><input type="radio" name="paymentSelector" value="bank"> Bank Account (eCheck)</label>
                <div class="fields-container" id="bank-fields">
                    <input type="text" id="nameOnAccount" placeholder="Name on Account">
                    <input type="text" id="accountNumber" placeholder="Account Number">
                    <input type="text" id="routingNumber" placeholder="Routing Number">
                    <select id="accountType">
                        <option value="checking">Checking</option>
                        <option value="businessChecking">Business Checking</option>
                        <option value="savings">Savings</option>
                    </select>
                </div>
            </div>

            <button id="submitBtn" type="button">Authorize & Place Order (v4.0)</button>
        </div>

        <div id="loading-ui">
            <h3>Processing...</h3>
            <div style="font-size: 30px; color: var(--vc-blue);">• • •</div>
            <p>Please do not refresh the page.</p>
        </div>
    </div>

    <div id="status-log"></div>

    <form id="zohoForm" method="POST" target="_top"
          action="https://creatorapp.zohopublic.com/valleycranellc/crane-booking-system/form-perma/Helper_Form/C49KhhrfYeYO1HGjt3zPYgB9OvXUg5Xtd7XaFh7awkwO3W2JNTFKJyuUjr9wW8hJ0Rn6yC1VDEEbezvMwJ54nDpHMsw4FKQtF9Us">
        <input type="hidden" name="Nonce" id="z_nonce">
        <input type="hidden" name="Booking_ID_Ref" id="z_booking_id">
    </form>

    <script src="https://js.authorize.net/v1/Accept.js" charset="utf-8"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            
            // --- LIVE CONFIGURATION ---
            var authData = {
                clientKey: "5Z7kuuw9W5tta8kER8434F89ExM9CcFC6W6J85HkgWVxfge4h6ZfA6RD55Gn9EZx", 
                apiLoginID: "6c7g447SAu9v"
            };

            // --- LISTENERS (No inline onclicks) ---
            var cardBtn = document.getElementById('btn-select-card');
            var bankBtn = document.getElementById('btn-select-bank');
            var submitBtn = document.getElementById('submitBtn');

            if(cardBtn) cardBtn.addEventListener('click', function() { toggleMethod('card'); });
            if(bankBtn) bankBtn.addEventListener('click', function() { toggleMethod('bank'); });
            if(submitBtn) submitBtn.addEventListener('click', function() { runTokenization(); });

            // --- HELPER: SHOW ERRORS ON PAGE (NO ALERTS) ---
            function showError(msg) {
                var logBox = document.getElementById("status-log");
                if(logBox) {
                    logBox.style.display = "block";
                    logBox.innerHTML = "⚠️ " + msg;
                    console.log("Error displayed: " + msg);
                }
            }

            function toggleMethod(val) {
                var radio = document.querySelector('input[value="' + val + '"]');
                if(radio) radio.checked = true;

                document.getElementById('btn-select-card').classList.remove('active');
                document.getElementById('btn-select-bank').classList.remove('active');

                if(val === 'card') {
                    document.getElementById('btn-select-card').classList.add('active');
                } else {
                    document.getElementById('btn-select-bank').classList.add('active');
                }
            }

            function runTokenization() {
                // Clear previous errors
                document.getElementById("status-log").style.display = "none";
                
                if (typeof Accept === "undefined") {
                    showError("Security Error: Payment library failed to load. Please refresh.");
                    return;
                }

                // Smart URL Check
                var queryString = window.location.search;
                if (!queryString && window.parent && window.parent !== window) {
                    try { queryString = window.parent.location.search; } catch (e) {}
                }

                const urlParams = new URLSearchParams(queryString);
                const bookingId = urlParams.get('bookingId');
                
                if(!bookingId) {
                    showError("System Error: No Booking ID found. Please use the link sent to your email.");
                    return;
                }

                var methodSelector = document.querySelector('input[name="paymentSelector"]:checked');
                var method = methodSelector ? methodSelector.value : 'card'; 
                var secureData = { authData: authData };

                if (method === 'card') {
                    var cn = document.getElementById('cardNumber').value.replace(/\s+/g, '');
                    if(cn.length < 13) { showError("Please enter a valid card number."); return; }
                    
                    secureData.cardData = {
                        cardNumber: cn,
                        month: document.getElementById('expMonth').value,
                        year: document.getElementById('expYear').value,
                        cardCode: document.getElementById('cardCode').value
                    };
                } else {
                    var rout = document.getElementById('routingNumber').value;
                    var acc = document.getElementById('accountNumber').value;
                    if(rout.length < 9 || acc.length < 4) { showError("Please check your banking details."); return; }

                    secureData.bankData = {
                        accountNumber: acc,
                        routingNumber: rout,
                        nameOnAccount: document.getElementById('nameOnAccount').value,
                        accountType: document.getElementById('accountType').value
                    };
                }

                document.getElementById('payment-interface').style.display = 'none';
                document.getElementById('loading-ui').style.display = 'block';

                try {
                    Accept.dispatchData(secureData, responseHandler);
                } catch (e) {
                    document.getElementById('loading-ui').style.display = 'none';
                    document.getElementById('payment-interface').style.display = 'block';
                    showError("System Crash: " + e.message);
                }
            }

            function responseHandler(response) {
                if (response.messages.resultCode === "Error") {
                    var errText = response.messages.message[0].text;
                    
                    // Reset UI
                    document.getElementById('loading-ui').style.display = 'none';
                    document.getElementById('payment-interface').style.display = 'block';
                    
                    showError("Payment Failed: " + errText);
                } else {
                    // Success!
                    document.getElementById('z_nonce').value = response.opaqueData.dataValue;
                    
                    var finalQs = window.location.search;
                    if (!finalQs && window.parent && window.parent !== window) {
                        try { finalQs = window.parent.location.search; } catch(e){}
                    }
                    const finalParams = new URLSearchParams(finalQs);
                    document.getElementById('z_booking_id').value = finalParams.get('bookingId');
                    
                    document.getElementById('zohoForm').submit();
                }
            }
        });
    </script>
</body>
</html>
